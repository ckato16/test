<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Piano Roll Trainer – Twinkle Twinkle Little Star</title>
<style>
body {
  background:#fff;
  color:#000;
  font-family:Arial, sans-serif;
  text-align:center;
  margin:0;
  overflow:hidden;
}
h1 {margin:10px;}
#controls {margin:10px;}
#keyboard {
  display:flex;
  justify-content:center;
  margin-top:20px;
}
.key {
  height:200px; margin:1px;
  background:#eee; border:1px solid #999; border-radius:4px;
  line-height:200px; font-weight:bold; font-size:18px;
  user-select:none; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
}
.key.active { background:#4A90E2; color:#fff; }
#canvas {
  display:block; margin:20px auto;
  background:#fafafa; border:1px solid #ccc;
}
#score { font-size:20px; margin:10px; }
</style>
</head>
<body>

<h1>Piano Trainer: Twinkle Twinkle Little Star</h1>
<div id="controls">
  <button id="playBtn">▶️ Play</button>
  <button id="stopBtn">⏹️ Stop</button>
</div>
<canvas id="canvas" width="700" height="400"></canvas>
<div id="keyboard"></div>
<div id="score">Score: 0</div>

<script>
const notes = ['C','D','E','F','G','A','B'];
const keyMap = { 'C':'C','D':'D','E':'E','F':'F','G':'G','A':'A','B':'B' };

// --- Twinkle Twinkle simplified sequence ---
const song = [
  {n:'C', t:0},{n:'C', t:1},{n:'G', t:2},{n:'G', t:3},
  {n:'A', t:4},{n:'A', t:5},{n:'G', t:6},
  {n:'F', t:8},{n:'F', t:9},{n:'E', t:10},{n:'E', t:11},
  {n:'D', t:12},{n:'D', t:13},{n:'C', t:14}
];

// --- Canvas setup ---
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
let playing=false, startTime=0, score=0;
const hitY = 350; // Y position of keyboard/hit line

// --- Keyboard setup ---
const keyboardDiv=document.getElementById("keyboard");
const keys={};
const keyWidth = canvas.width / notes.length;  // align canvas and keyboard
notes.forEach(n=>{
  const div=document.createElement("div");
  div.className="key";
  div.style.width = (keyWidth - 2) + "px"; // -2 for margin/border
  div.textContent=n;
  div.onclick = ()=>userPlay(n);
  keyboardDiv.appendChild(div);
  keys[n]=div;
});

// --- Play / Stop buttons ---
document.getElementById("playBtn").onclick=()=>{
  if(!playing){ 
    score=0; 
    song.forEach(s=>s.hit=false);
    startTime=performance.now()/1000; 
    playing=true; 
    animate(); 
  }
};
document.getElementById("stopBtn").onclick=()=>{ playing=false; };

// --- Keyboard input ---
window.addEventListener("keydown",e=>{
  const k=e.key.toUpperCase();
  if(keyMap[k]) userPlay(keyMap[k]);
});

// --- User note input ---
function userPlay(n){
  activateKey(n);
  checkNoteMatch(n);
  playTone(n);
}

// --- Activate visual feedback on key ---
function activateKey(note){
  if(!keys[note]) return;
  keys[note].classList.add("active");
  setTimeout(()=>keys[note].classList.remove("active"),150);
}

// --- Check if user matched a falling note ---
function checkNoteMatch(note){
  const now=(performance.now()/1000)-startTime;
  for(const s of song){
    if(Math.abs(now-s.t)<0.3 && s.n===note && !s.hit){
      s.hit=true;
      updateScore();
      break;
    }
  }
}

// --- Update score as percentage ---
function updateScore(){
  const hits = song.filter(s=>s.hit).length;
  const total = song.length;
  const percent = Math.round((hits/total)*100);
  document.getElementById("score").textContent = `Score: ${percent}%`;
}

// --- Draw falling notes ---
function animate(){
  if(!playing) return;
  const now=(performance.now()/1000)-startTime;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Draw hit line
  ctx.strokeStyle="#aaa";
  ctx.beginPath();
  ctx.moveTo(0,hitY);
  ctx.lineTo(canvas.width,hitY);
  ctx.stroke();

  // Draw notes
  const speed=80; // pixels per second
  for(const s of song){
    const x = notes.indexOf(s.n) * keyWidth;
    const y = hitY - (speed*(s.t - now)); // falling down
    if(y<canvas.height && y>-40){
      ctx.fillStyle = s.hit ? "#bbb" : "magenta";
      ctx.fillRect(x, y, keyWidth, 20);
    }
  }

  // Stop when song ends
  if(now > song[song.length-1].t + 2) playing=false;

  requestAnimationFrame(animate);
}

// --- Simple sound playback ---
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
function playTone(note){
  const freqs={C:261.63,D:293.66,E:329.63,F:349.23,G:392.00,A:440.00,B:493.88};
  const osc=audioCtx.createOscillator();
  const gain=audioCtx.createGain();
  osc.type='sine';
  osc.frequency.value=freqs[note];
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  gain.gain.setValueAtTime(0.3,audioCtx.currentTime);
  osc.stop(audioCtx.currentTime+0.2);
}

// --- Microphone pitch detection ---
navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
  const analyser=audioCtx.createAnalyser();
  analyser.fftSize=2048;
  const timeData=new Float32Array(analyser.fftSize);
  const source=audioCtx.createMediaStreamSource(stream);
  source.connect(analyser);

  function detect(){
    analyser.getFloatTimeDomainData(timeData);
    const freq=autoCorrelate(timeData,audioCtx.sampleRate);
    if(freq>0){
      const {note}=freqToNoteName(freq);
      activateKey(note);
      checkNoteMatch(note);
    }
    requestAnimationFrame(detect);
  }
  detect();
});

// --- Auto-correlation pitch detection ---
function autoCorrelate(buf,sampleRate){
  let SIZE=buf.length;
  let rms=0;
  for(let i=0;i<SIZE;i++) rms+=buf[i]*buf[i];
  rms=Math.sqrt(rms/SIZE);
  if(rms<0.01) return -1;
  let r1=0,r2=SIZE-1,thres=0.2;
  for(let i=0;i<SIZE/2;i++) if(Math.abs(buf[i])<thres){ r1=i; break; }
  for(let i=1;i<SIZE/2;i++) if(Math.abs(buf[SIZE-i])<thres){ r2=SIZE-i; break; }
  buf=buf.slice(r1,r2); SIZE=buf.length;
  const c=new Array(SIZE).fill(0);
  for(let i=0;i<SIZE;i++) for(let j=0;j<SIZE-i;j++) c[i]+=buf[j]*buf[j+i];
  let d=0; while(c[d]>c[d+1]) d++;
  let maxval=-1,maxpos=-1;
  for(let i=d;i<SIZE;i++){if(c[i]>maxval){maxval=c[i];maxpos=i;}}
  let T0=maxpos;
  return sampleRate/T0;
}

function freqToNoteName(f){
  const A4=440;
  const noteNum=12*Math.log2(f/A4)+69;
  const n=Math.round(noteNum);
  const names=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  const note=names[n%12];
  const octave=Math.floor(n/12)-1;
  return {note,octave};
}
</script>
</body>
</html>
