<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spectrum & Spectrogram Visualizer</title>
<style>
  body {
    background:#fff;
    color:#000;
    font-family:Arial, sans-serif;
    text-align:center;
    margin:0;
    padding:0;
  }
  h1 { margin:20px; }
  #container {
    display:flex;
    justify-content:center;
    gap:20px;
  }
  .canvas-container {
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  canvas {
    border:1px solid #ccc;
    background:#fff;
  }
  button {
    margin-top:10px;
    padding:8px 15px;
    font-size:14px;
  }
</style>
</head>
<body>

<h1>Spectrum & Spectrogram Visualizer</h1>

<div id="container">
  <div class="canvas-container">
    <canvas id="spectrumCanvas" width="500" height="500"></canvas>
  </div>
  <div class="canvas-container">
    <canvas id="spectrogramCanvas" width="500" height="500"></canvas>
  </div>
</div>

<script>
const spectrumCanvas = document.getElementById("spectrumCanvas");
const spectrumCtx = spectrumCanvas.getContext("2d");
const spectrogramCanvas = document.getElementById("spectrogramCanvas");
const spectrogramCtx = spectrogramCanvas.getContext("2d");

const maxSpectrogramSeconds = 10;
const spectrogramFrames = [];
let mediaRecorder, audioChunks = [];

navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);

  const source = audioCtx.createMediaStreamSource(stream);
  source.connect(analyser);

  mediaRecorder = new MediaRecorder(stream);
  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
  mediaRecorder.start();

  const maxFreq = 2000; // Hz
  const Nyquist = audioCtx.sampleRate/2;
  const maxBin = Math.floor(bufferLength*(maxFreq/Nyquist));

  function draw() {
    analyser.getByteFrequencyData(dataArray);

    drawSpectrum(dataArray, maxBin, maxFreq);
    saveForSpectrogram(dataArray, maxBin);
    drawSpectrogram(maxFreq);

    requestAnimationFrame(draw);
  }

  draw();
});

// --- Spectrum ---
function drawSpectrum(dataArray, maxBin, maxFreq){
  const ctx = spectrumCtx;
  const width = spectrumCanvas.width;
  const height = spectrumCanvas.height;
  ctx.fillStyle = "#fff";
  ctx.fillRect(0, 0, width, height);

  const leftMargin = 50, bottomMargin = 50, topMargin = 40;
  const graphW = width - leftMargin - 20;
  const graphH = height - bottomMargin - topMargin;
  const originX = leftMargin;
  const originY = height - bottomMargin;

  // axes
  ctx.strokeStyle = "#000";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(originX, originY);
  ctx.lineTo(originX+graphW, originY);
  ctx.moveTo(originX, originY);
  ctx.lineTo(originX, topMargin);
  ctx.stroke();

  ctx.font="12px Arial";
  ctx.fillStyle="#000";
  // x-axis ticks
  const tickCount=5;
  for(let i=0;i<=tickCount;i++){
    const f = (i/tickCount)*maxFreq;
    const x = originX + (f/maxFreq)*graphW;
    ctx.beginPath();
    ctx.moveTo(x, originY);
    ctx.lineTo(x, originY+5);
    ctx.stroke();
    ctx.fillText(f.toFixed(0)+" Hz", x-15, originY+20);
  }
  ctx.fillText("Frequency (Hz)", originX+graphW/2-40, originY+35);

  // y-axis ticks
  const yTicks=5;
  for(let i=0;i<=yTicks;i++){
    const val = (i/yTicks)*255;
    const y = originY - (i/yTicks)*graphH;
    ctx.beginPath();
    ctx.moveTo(originX-5, y);
    ctx.lineTo(originX, y);
    ctx.stroke();
    ctx.fillText(val.toFixed(0), originX-40, y+4);
  }
  ctx.save();
  ctx.translate(15, height/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText("Amplitude",0,0);
  ctx.restore();

  // spectrum bars (unfilled black outline)
  const barWidth = graphW / maxBin;
  ctx.strokeStyle = "#000"; // black outline
  ctx.lineWidth = 1;
  for(let i=0;i<maxBin;i++){
    const barHeight = (dataArray[i]/255)*graphH;
    const x = originX + i*barWidth;
    const y = originY - barHeight;
    ctx.strokeRect(x, y, barWidth, barHeight);
  }
}

// --- Spectrogram ---
function saveForSpectrogram(dataArray, maxBin){
  const col = new Uint8Array(maxBin);
  for(let i=0;i<maxBin;i++) col[i] = dataArray[i];
  spectrogramFrames.push(col);
  const maxFrames = spectrogramCanvas.width;
  if(spectrogramFrames.length > maxFrames) spectrogramFrames.shift();
}

function drawSpectrogram(maxFreq){
  const ctx = spectrogramCtx;
  const width = spectrogramCanvas.width;
  const height = spectrogramCanvas.height;
  ctx.fillStyle="#fff";
  ctx.fillRect(0,0,width,height);

  const leftMargin = 50, bottomMargin = 50, topMargin = 40;
  const graphW = width - leftMargin - 20;
  const graphH = height - bottomMargin - topMargin;

  const frames = spectrogramFrames;
  const maxFrames = frames.length;
  const maxBin = frames[0]?.length || 0;

  // draw spectrogram (inverted grayscale: high = black, low = white)
  for(let x=0;x<maxFrames;x++){
    const col = frames[x];
    for(let y=0;y<maxBin;y++){
      const v = col[y]/255;
      const intensity = 255 - Math.floor(v*255); // invert
      ctx.fillStyle = `rgb(${intensity},${intensity},${intensity})`;
      const px = leftMargin + x*(graphW/maxFrames);
      const py = topMargin + graphH - y*(graphH/maxBin);
      ctx.fillRect(px, py, Math.ceil(graphW/maxFrames), Math.ceil(graphH/maxBin));
    }
  }

  // axes
  ctx.strokeStyle="#000";
  ctx.lineWidth=1;
  ctx.beginPath();
  ctx.moveTo(leftMargin, topMargin);
  ctx.lineTo(leftMargin, topMargin + graphH);
  ctx.lineTo(leftMargin + graphW, topMargin + graphH);
  ctx.stroke();

  ctx.font="12px Arial";
  ctx.fillStyle="#000";

  // x-axis labels
  ctx.fillText("5 s", leftMargin + graphW*0.5 - 10, topMargin + graphH + 25);
  ctx.fillText("10 s", leftMargin + graphW - 15, topMargin + graphH + 25);
  ctx.fillText("Time (s)", leftMargin + graphW/2 - 20, topMargin + graphH + 40);

  // y-axis labels (frequency)
  const yTicks=5;
  for(let i=0;i<=yTicks;i++){
    const f = (i/yTicks)*maxFreq;
    const y = topMargin + graphH - (i/yTicks)*graphH;
    ctx.fillText(f.toFixed(0)+" Hz", 5, y+4);
  }
  ctx.save();
  ctx.translate(15, topMargin + graphH/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText("Frequency (Hz)",0,0);
  ctx.restore();
}
</script>

</body>
</html>
