<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Piano Trainer ‚Äì Twinkle Twinkle Little Star</title>
<style>
  body {
    font-family: sans-serif;
    background: white;
    text-align: center;
    margin: 0;
    padding: 20px;
  }
  canvas {
    display: block;
    margin: 10px auto;
    background: #f4f4f4;
    border: 1px solid #ccc;
  }
  #keyboard {
    position: relative;
    width: 560px;
    height: 200px;
    margin: 20px auto;
  }
  .white-key {
    position: absolute;
    bottom: 0;
    width: 70px;
    height: 200px;
    background: white;
    border: 1px solid black;
    z-index: 1;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    font-weight: bold;
    cursor: pointer;
    user-select: none;
    transition: background 0.1s;
  }
  .white-key.active {
    background: lightblue;
  }
  .controls {
    margin: 15px 0;
  }
  .controls button {
    background: #007bff;
    border: none;
    color: white;
    padding: 8px 14px;
    margin: 4px;
    font-size: 16px;
    border-radius: 4px;
    cursor: pointer;
  }
  .controls button:disabled {
    background: #ccc;
    cursor: not-allowed;
  }
  .accuracy {
    margin-top: 10px;
    font-size: 1.2em;
  }
</style>
</head>
<body>

<h1>üéπ Piano Trainer ‚Äì Twinkle Twinkle Little Star</h1>

<div class="controls">
  <button id="playBtn">‚ñ∂ Play</button>
  <button id="stopBtn" disabled>‚èπ Stop</button>
</div>

<canvas id="roll" width="560" height="400"></canvas>
<div id="keyboard"></div>
<div class="accuracy" id="accuracy">Hit accuracy: 0%</div>

<script>
// ---------------- CONFIG ----------------
const NOTES = ['C','D','E','F','G','A','H','C2'];
const NOTE_TO_PITCH = { C:60, D:62, E:64, F:65, G:67, A:69, H:71, C2:72 };
const PITCH_TO_NOTE = Object.fromEntries(Object.entries(NOTE_TO_PITCH).map(([k,v])=>[v,k]));
const pressed = new Set();
let hits = 0, total = 0;
let playing = false;

// ---------------- AUDIO ----------------
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const activeOsc = {};

async function ensureAudio() {
  if (audioCtx.state === "suspended") await audioCtx.resume();
}

// ---------------- CREATE KEYBOARD ----------------
const keyboard = document.getElementById('keyboard');
NOTES.forEach((note, i) => {
  const key = document.createElement('div');
  key.className = 'white-key';
  key.style.left = (i * 70) + 'px';
  key.textContent = note;
  key.dataset.note = note;
  key.onmousedown = () => press(note);
  key.onmouseup = () => release(note);
  keyboard.appendChild(key);
});

document.addEventListener('keydown', e => {
  const k = e.key.toUpperCase();
  if (NOTES.includes(k) && !pressed.has(k)) press(k);
});
document.addEventListener('keyup', e => {
  const k = e.key.toUpperCase();
  if (NOTES.includes(k)) release(k);
});

function press(note) {
  pressed.add(note);
  document.querySelectorAll('.white-key').forEach(k => {
    if (k.dataset.note === note) k.classList.add('active');
  });
  playNote(NOTE_TO_PITCH[note]);
}
function release(note) {
  pressed.delete(note);
  document.querySelectorAll('.white-key').forEach(k => {
    if (k.dataset.note === note) k.classList.remove('active');
  });
  stopNote(NOTE_TO_PITCH[note]);
}

function playNote(pitch, duration = 0.5) {
  const freq = 440 * Math.pow(2, (pitch - 69) / 12);
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
  osc.connect(gain).connect(audioCtx.destination);
  osc.frequency.value = freq;
  osc.start();
  osc.stop(audioCtx.currentTime + duration);
}

function stopNote() {} // (handled automatically)

// ---------------- SONG ----------------
const twinkleSeq = {
  notes: [
    {pitch:60, startTime:0, endTime:0.5},
    {pitch:60, startTime:0.5, endTime:1},
    {pitch:67, startTime:1, endTime:1.5},
    {pitch:67, startTime:1.5, endTime:2},
    {pitch:69, startTime:2, endTime:2.5},
    {pitch:69, startTime:2.5, endTime:3},
    {pitch:67, startTime:3, endTime:4},
    {pitch:65, startTime:4, endTime:4.5},
    {pitch:65, startTime:4.5, endTime:5},
    {pitch:64, startTime:5, endTime:5.5},
    {pitch:64, startTime:5.5, endTime:6},
    {pitch:62, startTime:6, endTime:6.5},
    {pitch:62, startTime:6.5, endTime:7},
    {pitch:60, startTime:7, endTime:8}
  ],
  totalTime: 8
};

// ---------------- FALLING NOTES ----------------
const canvas = document.getElementById('roll');
const ctx = canvas.getContext('2d');
const NOTE_HEIGHT = 25;
const NOTE_WIDTH = 70;
let startTime = null;

// the visual offset between note start and when it hits the keyboard
const pixelsPerSecond = 150;
const hitOffsetSec = (canvas.height - NOTE_HEIGHT) / pixelsPerSecond;

function drawFrame(ts) {
  if (!playing) return;
  if (!startTime) startTime = ts;
  const elapsed = (ts - startTime) / 1000;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  twinkleSeq.notes.forEach(note => {
    const visualStart = note.startTime - hitOffsetSec;
    const y = (elapsed - visualStart) * pixelsPerSecond;

    if (y > -NOTE_HEIGHT && y < canvas.height) {
      const noteName = PITCH_TO_NOTE[note.pitch];
      const noteIndex = NOTES.indexOf(noteName);
      const x = noteIndex * 70;
      ctx.fillStyle = pressed.has(noteName) ? 'limegreen' : 'dodgerblue';
      ctx.fillRect(x, y, NOTE_WIDTH, NOTE_HEIGHT);

      if (y >= canvas.height - NOTE_HEIGHT && y <= canvas.height - NOTE_HEIGHT / 2) {
        total++;
        if (pressed.has(noteName)) hits++;
      }
    }
  });

  const accuracy = total ? Math.round((hits / total) * 100) : 0;
  document.getElementById('accuracy').textContent = `Hit accuracy: ${accuracy}%`;

  if (elapsed < twinkleSeq.totalTime + hitOffsetSec + 3) {
    requestAnimationFrame(drawFrame);
  } else {
    stopPlayback();
  }
}

// ---------------- PLAYBACK ----------------
const playBtn = document.getElementById('playBtn');
const stopBtn = document.getElementById('stopBtn');

playBtn.onclick = async function startPlayback() {
  await ensureAudio();
  if (playing) return;
  playing = true;
  hits = total = 0;
  startTime = null;

  playBtn.disabled = true;
  stopBtn.disabled = false;

  const t0 = audioCtx.currentTime;

  // schedule each note sound
  twinkleSeq.notes.forEach(note => {
    const start = t0 + note.startTime;
    const end = t0 + note.endTime;
    const freq = 440 * Math.pow(2, (note.pitch - 69) / 12);
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    gain.gain.setValueAtTime(0.15, start);
    gain.gain.exponentialRampToValueAtTime(0.001, end);
    osc.frequency.value = freq;
    osc.connect(gain).connect(audioCtx.destination);
    osc.start(start);
    osc.stop(end);
  });

  requestAnimationFrame(drawFrame);
};

stopBtn.onclick = stopPlayback;

function stopPlayback() {
  playing = false;
  playBtn.disabled = false;
  stopBtn.disabled = true;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}
</script>
</body>
</html>
